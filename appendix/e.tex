\clearpage
%\chapter*{Appendix E: Water models}
\label{sec:appendixE}
%\addcontentsline{toc}{section}{Appendix E: Water models}
\clearpage

\section{IMPACT Global Hydrology Model (IGHM)}

IGHM is a semi-distributed parsimonious model. It simulates snow accumulation and melt, soil moisture balance, evapotranspiration, and runoff generation at monthly intervals and on each 0.5\textdegree x 0.5\textdegree grid cell spanning the global land surface except the Antarctic. 

Gridded output of hydrological fluxes, namely, effective rainfall, for calculating net irrigation water requirement in IMPACT water basin simulation model (IWSM), potential and actual evapotranspiration, and runoff are spatially aggregated to food production units (FPUs) within the river basin, weighted by grid cell areas, and then incorporated into IWSM.

The most dominant climatic drivers for water availability are precipitation and evaporative demand determined by net radiation at ground level, atmospheric humidity, wind speed, and temperature. In IGHM, the Priestley-Taylor equation is used to calculate potential evapotranspiration (Equation \ref{eq:pet}).\footnote{For $\alpha$, the humid and arid conditions are defined as having relative humidity greater or less than 60\% in the month with peak evapotranspiration.}

\begin{equation}
    \label{eq:pet}
    PET = \alpha \times \frac{\Delta}{\Delta + \gamma} \times (R_{n} - G) 
\end{equation}
where:
\begin{conditions}
 PET        &   Potential evapotranspiration (mm day\textsuperscript{-1}) \\
 \alpha     &   Scalar, 1.26 in humid climates, 1.74 in arid locations \\
 \Delta     &   Slope of the vapor pressure curve (kPa C\textdegree\textsuperscript{-1}) \\
 \gamma     &   psychrometric constant (kPa C\textdegree\textsuperscript{-1}) \\
 R_{n}      &   Net radiation at the land surface (mm day\textsuperscript{-1}) \\
 G          &   Soil heat flux density (mm day\textsuperscript{-1}) \\
\end{conditions}

Soil moisture balance is simulated at each grid cell using a single-layer water bucket. To represent subgrid variability of soil water-holding capacity $c$ we assume that it varies spatially within each grid cell following a parabolic distribution function (Equation \ref{eq:swhc}).

\begin{equation}
    \label{eq:swhc}
    f(c) = 1 - \left(1 - \frac{c}{C_{m}}\right)^{b}
\end{equation}
where:
\begin{conditions}
f(c) & Fraction of area in a grid cell that has soil water-holding capacity values lower than $c$ \\
C_{m} & Maximum soil water-holding capacity value across all points within the grid cell \\
b & shape parameter defining the degree of spatial variability of soil moisture-holding capacity $c$
\end{conditions}

The maximum amount of water that can be held in the grid cell is defined in Equation \ref{eq:mwhc}.

\begin{equation}
    \label{eq:mwhc}
    S_{m} = \int_{0}^{C_{m}} (1 - f(c)) \,dc = \frac{C_{m}}{1+b} 
\end{equation}

Refer to Fig. \ref{fig:ighm}, where $S_{m}$ equals the area between the parabolic curve and the x-axis with area fraction values of the x-axis ranging from 0 to 1.

Assuming that at any time $t$ each point in the grid cell is either at $C_{m}$ or at a constant moisture state $c$ (\textcolor{red}{Zhao 1992}), the mean areal water storage $S$ associated with soil water-holding capacity $c$ at time $t$ is given by equation \ref{eq:maws}

\begin{equation}
    \label{eq:maws}
    S_{t} = S_{m} \times \left[ 1 - \left( 1 - \frac{c_{t}}{C_{m}} \right)^{1+b} \right] 
\end{equation}

With precipitation $P_{t}$ and actual evapotranspiration $AET_{t}$ in time period $t$, runoff $R_{t}$ is determined by equation \ref{eq:runoff}.

\begin{subequations}
\label{eq:runoff}
If $c_{t} + P_{t} - AET \le C_{m}$, then
    \begin{align}
    R_{t} = P_{t} - AET_{t} - \Delta S 
    \end{align}
Where
    \begin{align}
    \Delta S = S_{m} \times \left[ \left( 1 - \frac{c_{t}}{c_m} \right)^{1+b} - \left( 1 - \frac{c_{t} + P_{t} - AET_{t}}{c_{m}} \right)^{1+b} \right] 
    \end{align}
Otherwise, If $c_{t} + P_{t} - AET \ge C_{m}$, then
    \begin{align}
    R_{t} = P_{t} - AET_{t} - (S_{m} - S_{t})
    \end{align}
where
    \begin{align}
    S_{t} = S_{m} \times \left[ \left( 1 - \frac{c_{t}}{c_m} \right)^{1+b} - \left( 1 - \frac{c_{t} + P_{t} - AET_{t}}{c_{m}} \right)^{1+b} \right] 
    \end{align}
\end{subequations}

The $AET$ is determined jointly by the $PET$ and relative soil moisture state in a grid cell at time period t (Equation \ref{eq:aet}).

\begin{equation}
    \label{eq:aet}
    AET_{t} = PET_{t} \times \frac{S_{t}}{S_{m}}
\end{equation}

Runoff generated in time period $t$ is divided into a surface runoff component $RS$ and a deep percolation component using partitioning factor $\lambda$ (Equation \ref{eq:runoffsurface}).

\begin{equation}
    \label{eq:runoffsurface}
    RS_{t} = \lambda \times R_{t}
\end{equation}

A linear reservoir is assumed to model base flow $RB$. The storage of the linear reservoir is linearly related to output, namely, base flow by a storage constant $\beta$ (\textcolor{red}{Chow et al. 1988}, Equation \ref{eq:rbflow}). 

\begin{equation}
    \label{eq:rbflow}
    RB_{t} = \beta \times G_{t}
\end{equation}

where:
\begin{conditions}
G_{t} & Storage value in time period $t$
\end{conditions}

The change of reservoir storage $\Delta G$ during time period $t$ equals the difference between deep percolation and base flow $RB$ occurred in this period (Equation \ref{eq:cirs})

\begin{equation}
    \label{eq:cirs}
    \Delta G = G_{t} - G_{t-1} = [(1 - \lambda) \times R_{t}] - RB_{t}
\end{equation}

Total runoff generated $R$ in time period $t$ is the sum of surface runoff $RS$ and base flow $RB$ (Equation \ref{eq:tgr}).
\begin{equation}
    \label{eq:tgr}
    R_{t} = RS_{t} + RB_{t}
\end{equation}

In the above equations (\ref{eq:pet} - \ref{eq:tgr}), calibration parameters include the subgrid variability shape parameter $b$, the total runoff partitioning parameter $\lambda$, the storage constant $\beta$, and the average soil water-holding capacity $S_{m}$. 

Conceptually, $S_{m}$ should equal available water - namely, field capacity less wilting point in a soil moisture–accounting perspective. However, because of the monthly time step adopted, using measured available water rather than calibrating $S_{m}$ can significantly overestimate runoff and underestimate actual evapotranspiration as found in our calibration experiments.

\section{IMPACT Water basin Simulation Model (IWSM)}

IWSM includes three components: 
\begin{enumerate}
    \item Water demand projections for domestic, industrial, livestock, and irrigation sectors;
    \item Water supply optimization; and
    \item Water allocation across sectors
\end{enumerate}

IWSM can also simulate water use impacts of technological and socioeconomic changes as well as climate change. 

\subsection*{Water demand projection}

Crop water requirement is defined by equation \ref{eq:cwr} for every $fpu$, activity $j$, year $yrs$ and month $m$.

\begin{equation}
    \label{eq:cwr}
    ETM_{fpu, j, yrs, m} = Kc_{fpu, j, m} \times ET0_{fpu, yrs, m}
\end{equation}

where:
\begin{conditions}
    ETM &   Monthly Crop Specific Evapotranspiration (mm) \\
    ET0	&	reference evapotranspiration (mm) \\
    Kc	&	crop coefficient \\
\end{conditions}

\subsubsection*{Domestic water demand}

Domestic water demand includes municipal water demand and rural domestic water demand. Annual per capita domestic water consumption is based on previous work with the International Water Management Institute (de Fraiture 2007; Rosegrant, Cai, and Cline 2002), with necessary adjustments to ensure that per capita consumption in rural and urban households is not less than 15 liters per day and 25 liters per day, respectively. Total domestic water consumption at the FPU level equals population multiplied by annual per capita consumption, as seen in IWSM equation 8. The growth of domestic per capita consumption is based on projections of per capita gross domestic product as seen in IWSM equation 9. In each region or basin, income elasticities $\eta$ of demand for domestic water use are synthesized based on the literature and available estimates (de Fraiture 2007). These elasticities of demand measure the propensity to consume water with respect to increases in per capita income. The elasticities also capture both direct income effects and conservation of domestic water use through technological and management change. In higher-income countries where per capita domestic consumption is high, the elasticities of demand imply that water demand will decline with increased income growth, whereas in developing countries the elasticities imply an increase in water consumption with increased income growth.

\subsubsection*{Industrial water demand}

Industrial water demand is modeled for the manufacturing and energy sectors using growth rates for the value-added by sector and energy production values for the electricity sector from the EPPA6 Model of the MIT Joint Program on the Science and Policy of Global Change (Chen et al. 2015). For many countries in Africa south of the Sahara, the projected industrial water demands are substantially lower than those in IMPACT 2, suggesting an underestimation. Therefore, for countries in Africa south of the Sahara we retained the projection method of IMPACT 2—namely, the industrial water demand is modeled as a nonlinear function of gross domestic production per capita and technology change. In IWSM equation 7, $\epsilon$ is income elasticity of demand, and $\gamma$t is the technology term, which is determined according to our perspectives on future industrial water demand and technological improvements in industrial water use in different regions.

\subsubsection*{Livestock water demand}

\subsubsection*{Irrigation water demand}

Irrigation water demand is assessed as the portion of crop water requirement (IWSM.2) not satisfied by precipitation or soil moisture based on hydrologic and agronomic characteristics. Net irrigation water demand (NIRWD) in an FPU is calculated based on an empirical crop water requirement function (Doorenbos and Pruit 1977) and irrigated area of the crop.

\subsection*{Water supply optimization}
IWSM is an optimization-driven simulation model with operating rules implicitly given by the objective function and constraints in the following quadratic programming model, coded in GAMS. The model runs at monthly time step and is solved for individual years using the CPLEX solver.  Adjacent years are linked through reservoir storage. Although the model is solved for all the 320 FPUs in the world simultaneously each year, it is the same as solving the 154 aggregated river basins individually because only FPUs within the same basin are connected through upstream-to-downstream water transport.

\subsection*{Intersector water allocation}

IWSM adopts a priority-based intersector water allocation scheme, assuming domestic water demand is the first priority, industrial and livestock demand is the second priority, and the remaining water is available for irrigation. The above water supply optimization already guarantees that nonirrigation water demand is met before irrigation water demand by forcing the shortage of supply to nonirrigation sectors to zero whenever possible. Therefore, for domestic, industrial, and livestock sectors, water supplies equal water demands if nonirrigation sector water supply shortage is zero in the IWSM water supply optimization solution. Otherwise, if shortage exists for nonirrigation sectors, water is allocated in the order of domestic, industrial, and livestock.


\section{IMPACT Crop Water Allocation and Stress Model (ICWASM)}

ICWASM allocates irrigation water among crops in an area. We use FAO’s K\textsubscript{y}/K\textsubscript{c} approach\footnote{K\textsubscript{y} is the Yield response factor, K\textsubscript{c} is the crop coefficient} (\textcolor{red}{Doorenbos and Kassam 1979}) to measure water stress using a monthly time step to include seasonality of water stress. The model maximizes the total value of production given fixed prices and also includes a measure of risk aversion for farmers in the objective function, which preserves a diversified production structure even in case of a drought.

The monthly ($m$) irrigation water delivered to FPU has to be less than or equal to total water available for that FPU. This constraint on water availability is expressed by the following inequality (Equation \ref{eq:awc}):

\begin{equation}
    \label{eq:awc}
    \sum_{j} CWDLV_{fpu, j, m} \times AREAC_{j, fpu} \leq WDAG_{fpu, m}
\end{equation}

where:
\begin{conditions}
CWDLV & Crop water delivered per hectare (millimeters) \\
AREAC & area for crop $j$ in the $fpu$ \\
WDAG  & Available water, which comes from $IWSM$ \\
\end{conditions}

The water supplied to each crop has to be less than or equal to the crop irrigation water demand ($IWD$) requirement, which does not include basin efficiency as shown in Equation \ref{eq:wsc}.

\begin{equation}
    \label{eq:wsc}
    CWDLV_{fpu, j, m} \leq IWD_{fpu, j, m}
\end{equation}

Additionally, water delivery ratio by crop ($RatioCWDLV$), and mean of water delivery ratio across crops ($MeanRatioV$) are calculated using Equation \ref{eq:wdrs} where $N_{j}$ is the total number of crops.

\begin{subequations}
    \label{eq:wdrs}
    \begin{align}
        RatioCWDLV_{fpu, j, m} = \frac{CWDLV_{fpu, j, m}}{IWD_{fpu, j, m}}
    \end{align}
    \begin{align}
        MeanRatioV_{fpu, m} = \frac{\sum_{j} RatioCWDLV_{fpu, j, m}}{N_{j}}
    \end{align}
\end{subequations}

The monthly irrigation yield reduction rate ($IYRMV$\footnote{As $IYRMV$ is the rate of reduction in yield by month, so a value of 1 means total crop loss.}, equation \ref{eq:miyrr}) is equal to the yield coefficient times the fraction of the water requirement unmet by supply for that month, given the cropping calendar. We ensure that yield reduction is less than 1, such that a yield reduction cannot lead to a negative yield. Ky is the yield coefficient, $precip$ is monthly precipitation, and $etcrop$ is the monthly crop-specific evapotranspiration (millimeters). Here, $IYRMSLKV$ is a slack variable to ensure $IYRMV$ $\leq$ 1.

\begin{equation}
    \label{eq:miyrr}
    IYRMV_{fpu, j, m} + IYRMSLKV_{fpu, j, m} = Ky_{fpu, j, m} \times \left[ 1 - \frac{MIN(precip_{fpu, m}, etcrop_{fpu, j, m})}{etcrop_{fpu, j, m}} \right]
\end{equation}

Equations \ref{eq:mmmys} and \ref{eq:ammys} provide alternative approaches to aggregating the monthly yield shocks to produce the annual shock. Both approaches are based on \textcolor{red}{Rao et al. 1988}. Equation \ref{eq:mmmys} shows a multiplicative representation of monthly yield shocks, where the annual yield reduction shock equals the product during the months of 1 minus the monthly irrigated yield reductions. It is a nonlinear equation that requires that the model be solved with a nonlinear programming (NLP) solver. Equation \ref{eq:ammys} shows an additive representation of monthly yield shocks where the annual yield reduction shock equals 1 minus the sum of the monthly irrigated yield reduction terms. The equation is linear, and the model can be solved as a quadratic programming (QCP) problem. A slack variable $IYRYSLKV$ is introduced to allow setting a minimum on the irrigated yield $YldIrr$ so that it cannot be less than the rainfed yield $YldRfd$ (Equation \ref{eq:iryc}). Alternatively, one could replace $YldRfd$ with the average of the full irrigated yield on part of the irrigated land, given the shortfall, and the rainfed yield on the rest, splitting $AREAC$ into irrigated and rainfed. In effect, for this strategy, the farmer would fully irrigate as much land as possible, given water availability, and let the rest operate as rainfed.

\begin{subequations}
\begin{align}
    \label{eq:mmmys}
    IYRYV_{fpu, j} = \prod_{m} (1-IYRMB_{fpu, j, m}) + \textcolor{red}{IYRYSLKV_{fpu, j}}
\end{align}
\begin{align}
    \label{eq:ammys}
    IYRYV_{fpu, j} = 1 - \sum_{m} IYRMV_{fpu, j, m} + \textcolor{red}{IYRYSLKV_{fpu, j}}
\end{align}
\begin{align}
    \label{eq:iryc}
    IYRYV_{fpu, j} \times YldIrr_{fpu, j} \geq YldRfd_{fpu, j}
\end{align}
\end{subequations}

In the above equations $IYRYV$ annual irrigated yield multiplier, so the new yield equals old yield times $IYRYV$, and a value of 1 means no crop loss.

Crop production is reduced by the value of the yield shock in ICWASM as defined in equation \ref{eq:cropprod}.

\begin{equation}
    \label{eq:cropprod}
    CProdV_{fpu, j} = IYRYV_{fpu, j} \times YldIrr_{fpu, j} \times AREAC_{j, fpu}
\end{equation}

The objective function of the ICWASM module includes total revenue and a risk-aversion term to dampen changes in allocation of water to crops from the previous year and is represented mathematically by equation \ref{eq:icwasmOBJ}, where $N_{j}$ is the total number of irrigated crops, $PP$ is the producer price of crop $j$ in an $fpu$, $N_{fpu}$ is the total number of FPUs, and $TOTVAL$ is the total expected value of crops in an $fpu$. $PP$ and $TOTVAL$ are both generated by the multimarket model. The first term (equation \ref{eq:icwasmOBJ1}) allocates available water to crops to maximize the expected value of output, given water shortages and yield shocks. The second term (equation \ref{eq:icwasmOBJ2}) minimizes the variance of the ratios of supply to demand for water across crops, reflecting the desire for risk-averse farmers to maintain their initial cropping pattern. The variance will be 0 when all crops have the same ratio of supply to demand for water. The third minimizes the slack variables (equation \ref{eq:icwasmOBJ3}). The $WGHT$s are weights on the three terms. The first two terms are scaled to have comparable magnitudes so that the $WGHT$s will reflect the relative importance of revenue maximization versus variance minimization. The value of $WGHT3$ is chosen to be large, ensuring that the slack variables are positive only when $IYRMV$ equals 1 and the irrigated yield equals the rainfed yield. Slack variable $IYRMSLKV$ is chosen to ensure $IYRMV$ $\leq$ 1.

\begin{subequations}
\label{eq:icwasmOBJ}

\begin{align}
    OBJV = MinStress + \textcolor{red}{MinRisk} + MinSlacks
\end{align}
\textcolor{red}{[MinStress is different in doc vs in model]}
\begin{align}
\label{eq:icwasmOBJ1}
%    MinStress = WGHT1 \times \frac{1}{N_{fpu}} \times \sum_{fpu} \frac{CProdV_{fpu, j} \times PP_{j, fpu}}{TOTVAL_{j, fpu}}
    MinStress = (1-IYRYV_{fpu, j})^{2} * YldIrr_{fpu, j} \times PP_{fpu, j}
\end{align}
\textcolor{red}{[MinRisk is commented out in model]}\textbf{}
\begin{align}
\label{eq:icwasmOBJ2}
    \textcolor{red}{MinRisk = IYRYV_{fpu, j} \times YldIrr_{fpu, j} \times AREAC_{j, fpu}}
\end{align}
\textcolor{red}{[MinSlacks is different in doc vs in model]}
\begin{align}
\label{eq:icwasmOBJ3}
    MinSlacks = IYRMSLKV_{fpu, j}
\end{align}

\end{subequations}